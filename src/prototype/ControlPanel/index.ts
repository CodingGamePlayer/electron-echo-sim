import { SatelliteSettings } from './SatelliteSettings/index.js';
import { OrbitSettings } from './OrbitSettings/index.js';
import { TargetSettings } from './TargetSettings/index.js';

/**
 * ControlPanelManager - Prototype 제어 패널 관리자
 */
export class ControlPanelManager {
  private sidebar: HTMLElement | null;
  private sidebarContent: HTMLElement | null;
  private satelliteSettings: SatelliteSettings | null;
  private orbitSettings: OrbitSettings | null;
  private targetSettings: TargetSettings | null;
  private viewer: any;

  constructor() {
    this.sidebar = null;
    this.sidebarContent = null;
    this.satelliteSettings = null;
    this.orbitSettings = null;
    this.targetSettings = null;
    this.viewer = null;
  }

  /**
   * 제어 패널 초기화
   */
  initialize(viewer?: any): void {
    this.createControlPanel(viewer);
    this.setupStyles();
  }

  /**
   * 제어 패널 생성
   */
  private createControlPanel(viewer?: any): void {
    this.viewer = viewer || null;
    // 기존 사이드바 확인
    this.sidebar = document.getElementById('sidebar');
    
    if (!this.sidebar) {
      console.warn('[ControlPanelManager] 사이드바를 찾을 수 없습니다.');
      return;
    }

    // 사이드바 콘텐츠
    this.sidebarContent = this.sidebar.querySelector('#sidebarContent');
    if (!this.sidebarContent) {
      console.warn('[ControlPanelManager] 사이드바 콘텐츠를 찾을 수 없습니다.');
      return;
    }

    // 기존 콘텐츠 제거
    this.sidebarContent.innerHTML = '';

    // 탭 컨테이너 생성
    const tabContainer = document.createElement('div');
    tabContainer.className = 'tab-container';

    // 탭 버튼 생성
    const tabButtons = document.createElement('div');
    tabButtons.className = 'tab-buttons';

    // 위성 설정 탭 버튼
    const satelliteTabButton = document.createElement('button');
    satelliteTabButton.className = 'tab-button active';
    satelliteTabButton.setAttribute('data-tab', 'satellite');
    satelliteTabButton.textContent = '위성 설정';
    tabButtons.appendChild(satelliteTabButton);

    // 궤도 설정 탭 버튼
    const orbitTabButton = document.createElement('button');
    orbitTabButton.className = 'tab-button';
    orbitTabButton.setAttribute('data-tab', 'orbit');
    orbitTabButton.textContent = '궤도 설정';
    tabButtons.appendChild(orbitTabButton);

    // 타겟 설정 탭 버튼
    const targetTabButton = document.createElement('button');
    targetTabButton.className = 'tab-button';
    targetTabButton.setAttribute('data-tab', 'target');
    targetTabButton.textContent = '타겟 설정';
    tabButtons.appendChild(targetTabButton);

    tabContainer.appendChild(tabButtons);

    // 위성 설정 탭 콘텐츠
    const satelliteTabContent = document.createElement('div');
    satelliteTabContent.id = 'satelliteTab';
    satelliteTabContent.className = 'tab-content active';
    satelliteTabContent.style.paddingTop = '0';
    tabContainer.appendChild(satelliteTabContent);

    // 궤도 설정 탭 콘텐츠
    const orbitTabContent = document.createElement('div');
    orbitTabContent.id = 'orbitTab';
    orbitTabContent.className = 'tab-content';
    orbitTabContent.style.paddingTop = '0';
    tabContainer.appendChild(orbitTabContent);

    // 타겟 설정 탭 콘텐츠
    const targetTabContent = document.createElement('div');
    targetTabContent.id = 'targetTab';
    targetTabContent.className = 'tab-content';
    tabContainer.appendChild(targetTabContent);

    this.sidebarContent.appendChild(tabContainer);

    // 각 설정 클래스 초기화
    this.satelliteSettings = new SatelliteSettings();
    this.satelliteSettings.initialize(satelliteTabContent, viewer);

    this.orbitSettings = new OrbitSettings();
    this.orbitSettings.initialize(orbitTabContent, viewer);

    this.targetSettings = new TargetSettings();
    this.targetSettings.initialize(targetTabContent, viewer);

    // 탭 전환 이벤트 설정
    this.setupTabEvents();

    // 기본으로 위성 설정 탭 활성화 (서버 초기화 시)
    this.activateTab('satellite');
  }

  /**
   * 탭 이벤트 설정
   */
  private setupTabEvents(): void {
    const tabButtons = this.sidebarContent?.querySelectorAll('.tab-button');
    const tabContents = this.sidebarContent?.querySelectorAll('.tab-content');

    if (!tabButtons || !tabContents) return;

    tabButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const targetTab = button.getAttribute('data-tab');

        // 모든 탭 버튼과 콘텐츠에서 active 클래스 제거
        tabButtons.forEach((btn) => btn.classList.remove('active'));
        tabContents.forEach((content) => content.classList.remove('active'));

        // 클릭한 탭 버튼과 해당 콘텐츠에 active 클래스 추가
        button.classList.add('active');
        const targetContent = this.sidebarContent?.querySelector(`#${targetTab}Tab`);
        if (targetContent) {
          targetContent.classList.add('active');
        }

        // 위성 설정 탭 클릭 시 위성 엔티티로 카메라 이동
        if (targetTab === 'satellite' && this.satelliteSettings) {
          this.satelliteSettings.flyToSatelliteEntity();
        }

        // 궤도 설정 탭 클릭 시 지구로 카메라 이동
        if (targetTab === 'orbit' && this.viewer) {
          // 위성 엔티티로 이동하는 애니메이션 취소
          if (this.satelliteSettings) {
            this.satelliteSettings.cancelCameraAnimation();
          }
          this.flyToEarth();
        }

        // 타겟 설정 탭 클릭 시 해당 타겟으로 카메라 이동
        if (targetTab === 'target' && this.targetSettings) {
          if (this.satelliteSettings) {
            this.satelliteSettings.cancelCameraAnimation();
          }
          this.targetSettings.flyToTarget();
        }
      });
    });
  }

  /**
   * 스타일 설정
   */
  private setupStyles(): void {
    // 필요한 경우 추가 스타일 설정
  }

  /**
   * 특정 탭 활성화 (서버 초기화 시 사용)
   */
  private activateTab(tabId: string): void {
    const tabButtons = this.sidebarContent?.querySelectorAll('.tab-button');
    const tabContents = this.sidebarContent?.querySelectorAll('.tab-content');

    if (!tabButtons || !tabContents) return;

    // 모든 탭 버튼과 콘텐츠에서 active 클래스 제거
    tabButtons.forEach((btn) => btn.classList.remove('active'));
    tabContents.forEach((content) => content.classList.remove('active'));

    // 지정된 탭 버튼과 콘텐츠에 active 클래스 추가
    const targetButton = Array.from(tabButtons).find(
      (btn) => btn.getAttribute('data-tab') === tabId
    ) as HTMLElement;
    const targetContent = this.sidebarContent?.querySelector(`#${tabId}Tab`) as HTMLElement;

    if (targetButton) {
      targetButton.classList.add('active');
    }
    if (targetContent) {
      targetContent.classList.add('active');
    }
  }

  /**
   * 지구로 카메라 이동
   */
  private flyToEarth(): void {
    if (!this.viewer) {
      return;
    }

    try {
      // 기존 카메라 애니메이션 취소
      if (this.viewer.camera._flight && this.viewer.camera._flight.isActive()) {
        this.viewer.camera.cancelFlight();
      }

      // trackedEntity 해제
      this.viewer.trackedEntity = undefined;

      // 지구로 카메라 이동 (flyHome 사용)
      this.viewer.camera.flyHome(1.5); // 1.5초 동안 이동
    } catch (error) {
      console.error('[ControlPanelManager] 지구로 카메라 이동 오류:', error);
    }
  }

  /**
   * 제어 패널 정리
   */
  cleanup(): void {
    if (this.satelliteSettings) {
      this.satelliteSettings.cleanup();
      this.satelliteSettings = null;
    }
    if (this.orbitSettings) {
      this.orbitSettings.cleanup();
      this.orbitSettings = null;
    }
    if (this.targetSettings) {
      this.targetSettings.cleanup();
      this.targetSettings = null;
    }
    if (this.sidebarContent) {
      this.sidebarContent.innerHTML = '';
    }
  }
}
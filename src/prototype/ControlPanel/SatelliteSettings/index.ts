import { SatelliteBusPayloadManager } from './SatelliteBusPayloadManager/index.js';
import { renderSatelliteSettingsForm, FormRendererCallbacks } from './_ui/form-renderer.js';
import { updateEntity } from './_util/entity-updater.js';
import { createSatelliteEntity } from './_util/entity-creator.js';
import { getDirectionForInputId } from './_util/direction-mapper.js';
import { waitForCameraReady, setupCameraAngle, setupCanvasFocus } from './_util/camera-manager.js';
import { 
  TIMER, 
  DEFAULT_POSITION, 
  DEFAULT_BUS_DIMENSIONS_M, 
  DEFAULT_BUS_DIMENSIONS_MM,
  DEFAULT_ANTENNA_DIMENSIONS_M, 
  DEFAULT_ANTENNA_GAP_M, 
  DEFAULT_ANTENNA_ORIENTATION,
  DEFAULT_SATELLITE_INFO,
  POSITION_VALIDATION
} from './constants.js';
import { setCameraToEntityHorizontal } from './_util/camera-manager.js';

/**
 * SatelliteSettings - Satellite settings tab management class
 */
export class SatelliteSettings {
  private container: HTMLElement | null;
  private viewer: any;
  private busPayloadManager: SatelliteBusPayloadManager | null;
  private updateDebounceTimer: number | null;
  private currentDirectionInputId: string | null;

  constructor() {
    this.container = null;
    this.viewer = null;
    this.busPayloadManager = null;
    this.updateDebounceTimer = null;
    this.currentDirectionInputId = null;
  }

  /**
   * Initialize satellite settings tab
   */
  initialize(container: HTMLElement, viewer?: any): void {
    this.container = container;
    this.viewer = viewer || null;
    if (this.viewer) {
      this.busPayloadManager = new SatelliteBusPayloadManager(this.viewer);
    }
    this.render();
    
    // 폼 렌더링 후 기본값으로 엔티티 자동 생성 및 카메라 이동
    if (this.viewer && this.busPayloadManager) {
      // Cesium 초기 카메라 애니메이션이 완료될 때까지 기다린 후 엔티티 생성
      waitForCameraReady(this.viewer, () => {
        this.createInitialEntity();
      });
    }
  }


  /**
   * 초기 엔티티 생성 (탭 접근 시 자동 생성)
   */
  private createInitialEntity(): void {
    if (!this.busPayloadManager || !this.viewer) {
      console.error('[SatelliteSettings] 초기 엔티티 생성 실패: busPayloadManager 또는 viewer가 없습니다.');
      return;
    }

    // 기본값으로 엔티티 직접 생성
    try {
      // 입력 필드에서 위치 정보 가져오기 (기본값 사용)
      const lonInput = (document.getElementById('prototypeSatelliteLongitude') as HTMLInputElement)?.value || String(DEFAULT_POSITION.LONGITUDE);
      const latInput = (document.getElementById('prototypeSatelliteLatitude') as HTMLInputElement)?.value || String(DEFAULT_POSITION.LATITUDE);
      const altInput = (document.getElementById('prototypeSatelliteAltitude') as HTMLInputElement)?.value || String(DEFAULT_POSITION.ALTITUDE_KM);
      
      const longitude = parseFloat(lonInput) || DEFAULT_POSITION.LONGITUDE;
      const latitude = parseFloat(latInput) || DEFAULT_POSITION.LATITUDE;
      const altitudeKm = parseFloat(altInput) || DEFAULT_POSITION.ALTITUDE_KM;
      
      // km를 미터로 변환 (Cesium은 미터 단위 사용)
      const altitude = altitudeKm * 1000;
      
      this.busPayloadManager.createSatellite(
        DEFAULT_SATELLITE_INFO.NAME,
        { longitude, latitude, altitude },
        {
          length: DEFAULT_BUS_DIMENSIONS_M.LENGTH,
          width: DEFAULT_BUS_DIMENSIONS_M.WIDTH,
          height: DEFAULT_BUS_DIMENSIONS_M.HEIGHT,
        },
        {
          height: DEFAULT_ANTENNA_DIMENSIONS_M.HEIGHT,
          width: DEFAULT_ANTENNA_DIMENSIONS_M.WIDTH,
          depth: DEFAULT_ANTENNA_DIMENSIONS_M.DEPTH,
          rollAngle: DEFAULT_ANTENNA_ORIENTATION.ROLL,
          pitchAngle: DEFAULT_ANTENNA_ORIENTATION.PITCH,
          yawAngle: DEFAULT_ANTENNA_ORIENTATION.YAW,
          initialElevationAngle: DEFAULT_ANTENNA_ORIENTATION.INITIAL_ELEVATION,
          initialAzimuthAngle: DEFAULT_ANTENNA_ORIENTATION.INITIAL_AZIMUTH,
        },
        DEFAULT_ANTENNA_GAP_M
      );

      // 엔티티 생성 후 약간의 지연을 두고 카메라를 BUS에 고정
      setTimeout(() => {
        const busEntity = this.busPayloadManager?.getBusEntity();
        
        if (busEntity) {
          // 카메라 각도 설정
          setupCameraAngle(this.viewer, busEntity);
          
          // Cesium 캔버스가 포커스를 가져가지 않도록 설정
          setupCanvasFocus(this.viewer);
        } else {
          console.error('[SatelliteSettings] BUS 엔티티를 찾을 수 없습니다.');
        }
      }, TIMER.ENTITY_CREATION_DELAY);
    } catch (error) {
      console.error('[SatelliteSettings] 초기 엔티티 생성 오류:', error);
    }
  }

  /**
   * Render satellite settings UI
   */
  private render(): void {
    if (!this.container) return;

    const callbacks: FormRendererCallbacks = {
      onInputFocus: (id: string) => {
        this.showDirectionForInput(id);
      },
      onInputBlur: (id: string) => {
        // 다른 입력 필드로 포커스 이동 시에도 화살표가 유지되도록 함
        setTimeout(() => {
          const activeElement = document.activeElement as HTMLElement;
          // 활성 요소가 다른 입력 필드가 아니고, 현재 방향 입력 필드도 아니면 화살표 제거
          if (activeElement && activeElement.tagName !== 'INPUT' && activeElement.id !== this.currentDirectionInputId) {
            this.hideDirectionArrows();
          }
        }, TIMER.INPUT_BLUR_DELAY);
      },
      onInputChange: () => {
        this.updateEntityFromInputs();
      },
      onCreateButtonClick: () => {
        this.createSatelliteEntity();
      },
      onAxisToggleChange: (checked: boolean) => {
        this.setAxisVisible(checked);
      }
    };

    renderSatelliteSettingsForm(this.container, callbacks);
  }

  /**
   * 입력 필드 값으로 엔티티 업데이트 (디바운싱 적용)
   */
  private updateEntityFromInputs(): void {
    // 디바운싱: 입력이 멈춘 후 일정 시간 후에 업데이트 실행
    if (this.updateDebounceTimer !== null) {
      clearTimeout(this.updateDebounceTimer);
    }
    
    this.updateDebounceTimer = window.setTimeout(() => {
      this.performEntityUpdate();
      this.updateDebounceTimer = null;
    }, TIMER.DEBOUNCE_DELAY);
  }

  /**
   * 실제 엔티티 업데이트 수행
   */
  private performEntityUpdate(): void {
    updateEntity(this.busPayloadManager, this.viewer);
    
    // 엔티티 업데이트 후에도 현재 포커스된 입력 필드가 있으면 화살표 다시 표시
    if (this.currentDirectionInputId) {
      const activeElement = document.activeElement as HTMLInputElement;
      if (activeElement && activeElement.id === this.currentDirectionInputId) {
        // 약간의 지연을 두어 엔티티 업데이트가 완료된 후 화살표 표시
        setTimeout(() => {
          // 엔티티가 여전히 존재하는지 확인
          if (this.busPayloadManager && this.busPayloadManager.getBusEntity()) {
            this.showDirectionForInput(this.currentDirectionInputId!);
          }
        }, TIMER.INPUT_FOCUS_RESTORE_DELAY);
      }
    }
  }

  /**
   * 위성 엔티티 생성
   */
  private createSatelliteEntity(): void {
    // 엔티티 생성 전 현재 포커스된 입력 필드 저장
    const activeElement = document.activeElement as HTMLElement;
    const wasInputFocused = activeElement && activeElement.tagName === 'INPUT' && 
                            activeElement.id && activeElement.id.startsWith('prototype');

    createSatelliteEntity(this.busPayloadManager, this.viewer, true);

    // 엔티티 생성 후 약간의 지연을 두고 카메라를 BUS에 고정
    setTimeout(() => {
      const busEntity = this.busPayloadManager?.getBusEntity();
      const antennaEntity = this.busPayloadManager?.getAntennaEntity();
      
      // 엔티티가 생성되었는지 확인
      if (!busEntity && !antennaEntity) {
        console.error('[SatelliteSettings] 엔티티가 생성되지 않았습니다!');
        alert('엔티티 생성에 실패했습니다. 콘솔을 확인하세요.');
        return;
      }

      // 카메라 각도 설정 (항상 동일한 각도로 설정)
      if (busEntity) {
        setupCameraAngle(this.viewer, busEntity);
      }
      
      // Cesium 캔버스가 포커스를 가져가지 않도록 설정
      setupCanvasFocus(this.viewer);
      
      // 포커스 복원: 이전에 입력 필드에 포커스가 있었다면 복원
      if (wasInputFocused && activeElement && activeElement.id) {
        // 카메라 조작 후 포커스 복원
        setTimeout(() => {
          const inputToFocus = document.getElementById(activeElement.id) as HTMLInputElement;
          if (inputToFocus && !inputToFocus.disabled && !inputToFocus.readOnly) {
            inputToFocus.focus();
            // 커서를 끝으로 이동
            inputToFocus.setSelectionRange(inputToFocus.value.length, inputToFocus.value.length);
          }
        }, TIMER.INPUT_FOCUS_RESTORE_DELAY);
      }
    }, TIMER.ENTITY_CREATION_CAMERA_DELAY);
  }


  /**
   * 지구로 이동
   */
  private moveSatelliteToEarth(): void {
    if (!this.busPayloadManager || !this.viewer) {
      alert('Cesium 뷰어가 초기화되지 않았습니다.');
      return;
    }

    // 입력된 위치 정보 가져오기
    const longitude = parseFloat((document.getElementById('prototypeSatelliteLongitude') as HTMLInputElement)?.value || String(DEFAULT_POSITION.LONGITUDE));
    const latitude = parseFloat((document.getElementById('prototypeSatelliteLatitude') as HTMLInputElement)?.value || String(DEFAULT_POSITION.LATITUDE));
    const altitudeKm = parseFloat((document.getElementById('prototypeSatelliteAltitude') as HTMLInputElement)?.value || String(DEFAULT_POSITION.ALTITUDE_KM));
    // km를 미터로 변환 (Cesium은 미터 단위 사용)
    const altitude = altitudeKm * 1000;

    // 입력값 검증
    if (longitude < POSITION_VALIDATION.LONGITUDE_MIN || longitude > POSITION_VALIDATION.LONGITUDE_MAX) {
      alert(`경도는 ${POSITION_VALIDATION.LONGITUDE_MIN} ~ ${POSITION_VALIDATION.LONGITUDE_MAX} 사이의 값이어야 합니다.`);
      return;
    }
    if (latitude < POSITION_VALIDATION.LATITUDE_MIN || latitude > POSITION_VALIDATION.LATITUDE_MAX) {
      alert(`위도는 ${POSITION_VALIDATION.LATITUDE_MIN} ~ ${POSITION_VALIDATION.LATITUDE_MAX} 사이의 값이어야 합니다.`);
      return;
    }
    if (altitudeKm < POSITION_VALIDATION.ALTITUDE_MIN_KM) {
      alert(`고도는 ${POSITION_VALIDATION.ALTITUDE_MIN_KM} 이상이어야 합니다.`);
      return;
    }

    try {
      // 위성 위치 업데이트
      this.busPayloadManager.updatePosition({ longitude, latitude, altitude });

      // 지구로 이동 시 항상 카메라를 엔티티에 고정하고 엔티티 생성 시와 동일한 각도로 설정
      const busEntity = this.busPayloadManager.getBusEntity();
      if (busEntity) {
        // BUS 크기 정보 가져오기
        const busLengthMm = parseFloat((document.getElementById('prototypeBusLength') as HTMLInputElement)?.value || String(DEFAULT_BUS_DIMENSIONS_MM.LENGTH));
        const busWidthMm = parseFloat((document.getElementById('prototypeBusWidth') as HTMLInputElement)?.value || String(DEFAULT_BUS_DIMENSIONS_MM.WIDTH));
        const busHeightMm = parseFloat((document.getElementById('prototypeBusHeight') as HTMLInputElement)?.value || String(DEFAULT_BUS_DIMENSIONS_MM.HEIGHT));
        
        // 카메라 설정
        setCameraToEntityHorizontal(this.viewer, busEntity, {
          length: busLengthMm,
          width: busWidthMm,
          height: busHeightMm
        });
      }

      alert('위성이 지구로 이동되었습니다.');
    } catch (error) {
      console.error('[SatelliteSettings] 지구로 이동 오류:', error);
      alert('지구로 이동 중 오류가 발생했습니다: ' + (error as Error).message);
    }
  }

  /**
   * XYZ 축 표시/숨김 설정
   */
  private setAxisVisible(visible: boolean): void {
    if (!this.busPayloadManager) {
      return;
    }

    this.busPayloadManager.setAxisVisible(visible);
    console.log(`[SatelliteSettings] XYZ 축 표시: ${visible ? 'ON' : 'OFF'}`);
  }

  /**
   * 입력 필드에 해당하는 방향 화살표 표시
   */
  private showDirectionForInput(inputId: string): void {
    if (!this.busPayloadManager) {
      return;
    }

    // 엔티티가 생성되어 있는지 확인
    const busEntity = this.busPayloadManager.getBusEntity();
    if (!busEntity) {
      // 엔티티가 없으면 나중에 다시 시도할 수 있도록 ID만 저장
      this.currentDirectionInputId = inputId;
      return;
    }

    this.currentDirectionInputId = inputId;

    // 입력 필드 ID에 따라 방향 결정
    const direction = getDirectionForInputId(inputId);

    if (direction) {
      this.busPayloadManager.showDirectionArrows(direction);
    }
  }

  /**
   * 방향 화살표 숨김
   */
  private hideDirectionArrows(): void {
    if (this.busPayloadManager) {
      this.busPayloadManager.removeDirectionArrows();
      this.currentDirectionInputId = null;
    }
  }


  /**
   * Cleanup satellite settings
   */
  cleanup(): void {
    // 디바운스 타이머 정리
    if (this.updateDebounceTimer !== null) {
      clearTimeout(this.updateDebounceTimer);
      this.updateDebounceTimer = null;
    }
    
    // 카메라 고정 해제
    if (this.viewer) {
      this.viewer.trackedEntity = undefined;
    }

    // 방향 화살표 제거
    this.hideDirectionArrows();

    if (this.busPayloadManager) {
      this.busPayloadManager.removeSatellite();
      this.busPayloadManager = null;
    }
    if (this.container) {
      this.container.innerHTML = '';
    }
    this.container = null;
    this.viewer = null;
    this.currentDirectionInputId = null;
  }
}
